// Generated by CoffeeScript 1.8.0
angular.module('Sonnets').controller('SonnetShowCtrl', function($scope, $document, $http, $pusher, $location, AnnotationCategories) {
  var annotationsChannel, client, presenceChannel, pusher, sonnetId;
  client = new Pusher('8dd714bf0a643abe835e');
  pusher = $pusher(client);
  sonnetId = /sonnets\/(\d+)/.exec($location.absUrl())[1];
  $http.get("/api/sonnets/" + sonnetId).success(function(data) {
    $scope.poem = data;
    return $scope.annotations = $scope.poem.annotations;
  });
  annotationsChannel = pusher.subscribe('annotations_channel');
  annotationsChannel.bind('new_annotation', function(poem) {
    return $scope.$apply(function() {
      return $scope.annotations = poem.annotations;
    });
  });
  $scope.submitAnnotation = function(e) {
    if (e.keyCode === 13) {
      $http.put("/api/sonnets/" + sonnetId + "/annotations", $scope.annotation);
      return $scope.annotation = null;
    }
  };
  $scope.categories = AnnotationCategories;
  presenceChannel = pusher.subscribe('presence-users');
  return $scope.members = presenceChannel.members;
});
